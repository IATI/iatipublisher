<template>
  <div
    class="fixed left-0 top-0 z-[100] flex h-screen w-screen flex-col items-center justify-center bg-white bg-opacity-100"
  >
    <svg
      class="h-[300px] w-[300px]"
      viewBox="0 0 201 201"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        d="M119.092 81.7599C123.643 86.3112 126.395 92.3545 126.842 98.7755C127.288 105.197 125.398 111.563 121.52 116.7C117.642 121.837 112.038 125.399 105.74 126.729C99.4427 128.06 92.8765 127.069 87.2522 123.939L91.1043 117.017C95.0587 119.217 99.6752 119.914 104.103 118.979C108.531 118.043 112.471 115.539 115.197 111.927C117.924 108.315 119.253 103.839 118.939 99.3248C118.625 94.8103 116.69 90.5614 113.49 87.3614L119.092 81.7599Z"
        fill="#A7EBEF"
      />
      <path
        class="animate-clockwise-spin"
        d="M66.4765 120.244C63.4636 115.062 61.6849 109.254 61.2783 103.273C60.8717 97.292 61.8481 91.2975 64.1318 85.7545C66.4155 80.2116 69.9451 75.269 74.4471 71.3102C78.949 67.3513 84.3022 64.4825 90.0917 62.9261C95.8811 61.3698 101.951 61.1677 107.831 62.3357C113.711 63.5036 119.244 66.0101 123.999 69.6609C128.754 73.3117 132.604 78.0086 135.252 83.3875C137.899 88.7663 139.272 94.6826 139.264 100.678L126.922 100.661C126.927 96.5615 125.988 92.5156 124.178 88.8373C122.368 85.159 119.735 81.947 116.483 79.4505C113.231 76.9539 109.448 75.2399 105.427 74.4412C101.406 73.6425 97.2548 73.7806 93.2957 74.8449C89.3366 75.9092 85.6758 77.8711 82.5972 80.5783C79.5186 83.2856 77.1049 86.6655 75.5432 90.456C73.9815 94.2466 73.3138 98.3459 73.5918 102.436C73.8699 106.526 75.0863 110.497 77.1466 114.042L66.4765 120.244Z"
        fill="#185568"
      />
      <path
        d="M52.651 100.132C52.7695 88.6826 57.0129 77.6597 64.6024 69.086C72.1919 60.5124 82.6186 54.9631 93.9692 53.4563C105.32 51.9495 116.833 54.5863 126.397 60.883C135.96 67.1796 142.933 76.7137 146.034 87.7358L138.078 89.9746C135.515 80.867 129.754 72.989 121.852 67.7861C113.949 62.5832 104.436 60.4044 95.0569 61.6494C85.6778 62.8945 77.0622 67.4799 70.791 74.5643C64.5198 81.6487 61.0135 90.757 60.9156 100.218L52.651 100.132Z"
        fill="#A7EBEF"
      />
      <path
        class="animate-couterclockwise-spin"
        d="M46.1111 85.7709C48.2283 78.0568 51.9702 70.8845 57.0859 64.7347C62.2015 58.5849 68.5728 53.5998 75.7725 50.1136C82.9722 46.6274 90.8341 44.7206 98.8309 44.5211C106.828 44.3215 114.775 45.8339 122.14 48.9567C129.504 52.0795 136.116 56.7407 141.532 62.6277C146.948 68.5147 151.043 75.4915 153.542 83.0904C156.042 90.6893 156.888 98.7347 156.023 106.687C155.159 114.64 152.605 122.316 148.532 129.2L141.213 124.871C144.669 119.029 146.836 112.516 147.57 105.769C148.303 99.0211 147.585 92.1947 145.464 85.7472C143.344 79.2998 139.869 73.3801 135.274 68.3851C130.679 63.3901 125.069 59.4353 118.82 56.7856C112.571 54.136 105.828 52.8528 99.043 53.0221C92.2579 53.1914 85.5873 54.8092 79.4785 57.7672C73.3697 60.7252 67.9639 64.9549 63.6233 70.1729C59.2828 75.3908 56.1079 81.4764 54.3115 88.0216L46.1111 85.7709Z"
        fill="#185568"
      />
      <path
        d="M44.8986 68.9279C52.6094 55.4676 64.9624 45.2797 79.6443 40.272C94.3262 35.2643 110.33 35.7802 124.659 41.7231C138.988 47.6661 150.659 58.6285 157.487 72.5574C164.315 86.4864 165.831 102.427 161.752 117.393L154.438 115.4C158.032 102.212 156.696 88.1671 150.68 75.894C144.664 63.6209 134.38 53.9618 121.755 48.7253C109.129 43.4889 95.028 43.0343 82.0915 47.4467C69.1549 51.8591 58.2704 60.8358 51.4763 72.696L44.8986 68.9279Z"
        fill="#A7EBEF"
      />
      <path
        class="animate-clockwise-spin"
        d="M50.7472 50.1067C57.3813 43.6086 65.2303 38.4808 73.8461 35.016C82.4619 31.5513 91.6758 29.8175 100.962 29.9136C110.247 30.0098 119.423 31.934 127.966 35.5763C136.508 39.2187 144.249 44.5079 150.747 51.1419C157.245 57.776 162.373 65.625 165.838 74.2408C169.303 82.8566 171.036 92.0705 170.94 101.356C170.844 110.642 168.92 119.818 165.278 128.36C161.635 136.903 156.346 144.644 149.712 151.142L144.984 146.315C150.984 140.438 155.768 133.436 159.062 125.71C162.357 117.984 164.097 109.685 164.184 101.286C164.271 92.8878 162.703 84.5543 159.569 76.7617C156.436 68.9691 151.798 61.87 145.92 55.8698C140.043 49.8696 133.042 45.0858 125.316 41.7915C117.59 38.4971 109.29 36.7568 100.892 36.6698C92.493 36.5829 84.1595 38.151 76.3669 41.2847C68.5744 44.4184 61.4753 49.0563 55.4751 54.9335L50.7472 50.1067Z"
        fill="#185568"
      />
      <circle cx="100.226" cy="100.625" r="18.6224" fill="#185568" />
    </svg>
    <p class="mt-6 px-6 text-center text-lg font-medium text-[#185568]">
      <template v-if="isFinalMessage">
        {{
          translatedData['common.common.this_is_taking_longer_than_expected']
        }}
        <a
          href="#"
          class="text-blue-600 underline"
          @click.prevent="cancelUpload"
          >{{ translatedData['common.common.cancel_and_start_again'] }}</a
        >
      </template>
      <template v-else>
        {{ currentMessage }}
      </template>
    </p>
  </div>
</template>

<script setup>
import ImportService from 'Services/import';
import { ref, onMounted, onBeforeUnmount, defineProps } from 'vue';

const props = defineProps({
  translatedData: {
    type: Object,
    required: true,
  },
});

let intervalId;

const messageKey = [
  'common.common.your_file_is_being_uploaded',
  'common.common.this_might_take_a_few_more_minutes',
  'common.common.were_still_working_on_it_hang_in_there',
  'common.common.almost_there_your_file_is_near_completion',
  'common.common.this_is_taking_longer_than_expected_would_you_like_to_cancel_and_start_again',
];

const currentMessage = ref(props.translatedData[messageKey[0]]);
const isFinalMessage = ref(false);

const cancelUpload = async () => {
  clearInterval(intervalId);

  try {
    const [ongoingRes, xlsRes] = await Promise.all([
      ImportService.cancelOngoingImports(),
      ImportService.cancelXLS(),
    ]);

    if (!ongoingRes?.success || !xlsRes?.success) {
      window.location.href = '/activities?cancel=false';
    }
    window.location.href = '/activities?cancel=true';
  } catch (error) {
    console.error('Error during cancellation:', error);
    window.location.href = '/activities?cancel=false';
  }
};

onMounted(() => {
  let index = 1;
  intervalId = setInterval(() => {
    if (index < messageKey.length - 1) {
      console.log(messageKey[index], props.translatedData[messageKey[index]]);
      currentMessage.value = props.translatedData[messageKey[index]];
      index++;
    } else {
      isFinalMessage.value = true;
      clearInterval(intervalId);
    }
  }, 3 * 60 * 1000);
});
onBeforeUnmount(() => {
  clearInterval(intervalId);
});
</script>
<style lang="scss" scoped>
.animate-clockwise-spin {
  animation: clockwise 1.5s linear infinite;
  transform-origin: center;
}

.animate-couterclockwise-spin {
  animation: couterclockwise 1.5s linear infinite;
  transform-origin: center;
}

@keyframes clockwise {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@keyframes couterclockwise {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(-360deg);
  }
}

p {
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(4px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
